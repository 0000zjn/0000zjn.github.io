---
title: 批量执行不确定数量的异步方法
date: 2019-10-31
updated: 2019-10-31
tags: JavaScript
---

Promise.all()参数可变时的使用方法

<!-- more -->

```
let pushTokenList = [];
let errIdList = [];
let functions = [];
userList.forEach((item)=>{
    let params = {
        TableName: process.env.USERS,
        KeyConditionExpression: "#id = :id",
        ProjectionExpression:"pushToken",
        ExpressionAttributeNames: {
            "#id": "id"
        },
        ExpressionAttributeValues: {
            ":id": item.userId
        }
    }
    functions.push(async ()=>{
        try {
            let data = await db.query(params).promise();
            if (data.Count === 0 || !data.Items[0].pushToken) {
                throw new Error().attr({code: 4001258, error_desc: "invalid userId", context: {userId: item.userId}});
            }else {
                pushTokenList.push(data.Items[0].pushToken);
            }
        }catch (err) {
            errIdList.push(err);
        }
    })
});

let promises = [];
functions.forEach(item=>{
    promises.push(item());
})
let result = await Promise.all(promises);

return {pushTokenList, errIdList}
```